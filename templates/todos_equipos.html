{% extends 'base.html' %}
{% block title %}Buscar Equipos{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Buscar Equipos</h2>
    
    <!-- Formulario de búsqueda -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="POST">
                <div class="row">
                    <div class="col-md-8">
                        <label for="busqueda" class="form-label">Buscar por código o número de serie:</label>
                        <input type="text" class="form-control" id="busqueda" name="busqueda" 
                               value="{{ busqueda or '' }}" placeholder="Ingresa código o número de serie...">
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">Buscar</button>
                        <a href="{{ url_for('todos_los_equipos') }}" class="btn btn-outline-secondary">Limpiar</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    {% if equipos %}
    <!-- Controles de filtrado adicionales -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <label for="filtroCliente" class="form-label">Filtrar por cliente:</label>
                    <input type="text" class="form-control" id="filtroCliente" placeholder="Nombre del cliente...">
                </div>
                <div class="col-md-4">
                    <label for="filtroMarca" class="form-label">Filtrar por marca:</label>
                    <input type="text" class="form-control" id="filtroMarca" placeholder="Marca del equipo...">
                </div>
                <div class="col-md-4">
                    <label for="ordenamiento" class="form-label">Ordenar por:</label>
                    <select class="form-select" id="ordenamiento">
                        <option value="cliente">Cliente A-Z</option>
                        <option value="codigo">Código A-Z</option>
                        <option value="marca">Marca A-Z</option>
                    </select>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <button class="btn btn-outline-secondary btn-sm" onclick="limpiarFiltros()">Limpiar filtros</button>
                    <span class="ms-3 text-muted" id="contador-resultados"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Resultados en Cards -->
    <div class="row" id="contenedor-equipos">
        {% for equipo in equipos %}
        <div class="col-12 col-md-6 col-lg-4 mb-3 equipo-item" 
             data-cliente="{{ equipo.nombre_cliente|lower }}"
             data-codigo="{{ equipo.codigo|lower }}"
             data-marca="{{ equipo.marca|lower if equipo.marca else '' }}">
            <div class="card h-100 equipo-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><strong>{{ equipo.codigo }}</strong></h6>
                    <span class="badge bg-primary">ID: {{ equipo.id_equipo }}</span>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <small class="text-muted">Cliente:</small><br>
                        <strong>{{ equipo.nombre_cliente }}</strong>
                    </div>
                    
                    <div class="row mb-2">
                        <div class="col-6">
                            <small class="text-muted">Serie:</small><br>
                            <strong>{{ equipo.nro_serie or '-' }}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Capacidad:</small><br>
                            <strong>{{ equipo.capacidad or '-' }}</strong>
                        </div>
                    </div>
                    
                    <div class="row mb-2">
                        <div class="col-6">
                            <small class="text-muted">Marca:</small><br>
                            <strong>{{ equipo.marca or '-' }}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Modelo:</small><br>
                            <strong>{{ equipo.modelo or '-' }}</strong>
                        </div>
                    </div>
                    
                    <div class="row mb-2">
                        <div class="col-6">
                            <small class="text-muted">Refrigerante:</small><br>
                            <strong>{{ equipo.refrigerante or '-' }}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Ubicación:</small><br>
                            <strong>{{ equipo.ubicacion or '-' }}</strong>
                        </div>
                    </div>
                    
                    <div class="row mb-2">
                        <div class="col-6">
                            <small class="text-muted">Altura:</small><br>
                            <strong>{{ 'Sí' if equipo.altura else 'No' }}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Fecha Inst.:</small><br>
                            <strong>
                                {% if equipo.fecha_inst %}
                                    {{ equipo.fecha_inst.strftime('%d/%m/%Y') if equipo.fecha_inst.strftime else equipo.fecha_inst }}
                                {% else %}
                                    Sin fecha
                                {% endif %}
                            </strong>
                        </div>
                    </div>
                    
                    {% if equipo.obs %}
                    <div class="mb-2">
                        <small class="text-muted">Observaciones:</small><br>
                        <span class="text-truncate d-block" title="{{ equipo.obs }}">{{ equipo.obs }}</span>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer">
                    <div class="botones-equipo">
                        <a href="{{ url_for('trabajos_equipo', id_equipo=equipo.id_equipo) }}" class="btn btn-info">
                            Ver Trabajos
                        </a>
                        <a href="{{ url_for('editar_equipo', id_equipo=equipo.id_equipo) }}" class="btn btn-warning">
                            Editar
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Mensaje cuando no hay resultados -->
    <div class="text-center mt-4 d-none" id="sin-resultados">
        <p class="text-muted">No se encontraron equipos que coincidan con los filtros.</p>
    </div>
    
    {% else %}
    {% if busqueda %}
    <div class="alert alert-info">
        No se encontraron equipos para la búsqueda: <strong>"{{ busqueda }}"</strong>
    </div>
    {% else %}
    <div class="alert alert-info">
        Usa el formulario de arriba para buscar equipos por código o número de serie.
    </div>
    {% endif %}
    {% endif %}

    <a href="{{ url_for('index') }}" class="btn btn-secondary mt-3">Volver al Inicio</a>
</div>

<style>
    .equipo-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border-left: 4px solid #007bff;
    }

    .equipo-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .card-header h6 {
        color: #495057;
    }

    /* Botones simples y claros */
    .botones-equipo {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .botones-equipo .btn {
        font-size: 0.95rem;
        padding: 10px 15px;
        font-weight: 500;
        border: none;
        border-radius: 5px;
        text-decoration: none;
        text-align: center;
        flex: 1;
    }
    
    .botones-equipo .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    /* En pantallas medianas, botones en fila */
    @media (min-width: 768px) {
        .botones-equipo {
            flex-direction: row;
        }
        
        .botones-equipo .btn {
            font-size: 0.8rem;
            padding: 8px 12px;
        }
    }

    /* Para móviles */
    @media (max-width: 768px) {
        .container {
            padding-left: 10px;
            padding-right: 10px;
        }
        
        h2 {
            font-size: 1.3rem;
        }
        
        .botones-equipo .btn {
            font-size: 1rem;
            padding: 12px 15px;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const filtroCliente = document.getElementById('filtroCliente');
        const filtroMarca = document.getElementById('filtroMarca');
        const ordenamiento = document.getElementById('ordenamiento');
        const contadorResultados = document.getElementById('contador-resultados');
        const sinResultados = document.getElementById('sin-resultados');
        
        function aplicarFiltros() {
            const textoCliente = filtroCliente ? filtroCliente.value.toLowerCase() : '';
            const textoMarca = filtroMarca ? filtroMarca.value.toLowerCase() : '';
            const tipoOrden = ordenamiento ? ordenamiento.value : 'cliente';
            
            let equiposVisibles = Array.from(document.querySelectorAll('.equipo-item'));
            
            // Filtrar por cliente
            if (textoCliente) {
                equiposVisibles = equiposVisibles.filter(item => {
                    const cliente = item.getAttribute('data-cliente');
                    return cliente.includes(textoCliente);
                });
            }
            
            // Filtrar por marca
            if (textoMarca) {
                equiposVisibles = equiposVisibles.filter(item => {
                    const marca = item.getAttribute('data-marca');
                    return marca.includes(textoMarca);
                });
            }
            
            // Ordenar
            equiposVisibles.sort((a, b) => {
                switch (tipoOrden) {
                    case 'codigo':
                        return a.getAttribute('data-codigo').localeCompare(b.getAttribute('data-codigo'));
                    case 'marca':
                        return a.getAttribute('data-marca').localeCompare(b.getAttribute('data-marca'));
                    default: // cliente
                        return a.getAttribute('data-cliente').localeCompare(b.getAttribute('data-cliente'));
                }
            });
            
            // Ocultar todos los equipos
            document.querySelectorAll('.equipo-item').forEach(item => {
                item.style.display = 'none';
            });
            
            // Mostrar solo los filtrados y ordenados
            const contenedor = document.getElementById('contenedor-equipos');
            equiposVisibles.forEach(item => {
                item.style.display = 'block';
                if (contenedor) {
                    contenedor.appendChild(item);
                }
            });
            
            // Actualizar contador
            if (contadorResultados) {
                const total = document.querySelectorAll('.equipo-item').length;
                contadorResultados.textContent = `Mostrando ${equiposVisibles.length} de ${total} equipos`;
            }
            
            // Mostrar/ocultar mensaje de sin resultados
            if (sinResultados) {
                const total = document.querySelectorAll('.equipo-item').length;
                if (equiposVisibles.length === 0 && total > 0) {
                    sinResultados.classList.remove('d-none');
                } else {
                    sinResultados.classList.add('d-none');
                }
            }
        }
        
        // Event listeners
        if (filtroCliente) {
            filtroCliente.addEventListener('input', aplicarFiltros);
        }
        if (filtroMarca) {
            filtroMarca.addEventListener('input', aplicarFiltros);
        }
        if (ordenamiento) {
            ordenamiento.addEventListener('change', aplicarFiltros);
        }
        
        // Función global para limpiar filtros
        window.limpiarFiltros = function() {
            if (filtroCliente) filtroCliente.value = '';
            if (filtroMarca) filtroMarca.value = '';
            if (ordenamiento) ordenamiento.value = 'cliente';
            aplicarFiltros();
        };
        
        // Aplicar filtros inicial
        if (document.querySelectorAll('.equipo-item').length > 0) {
            aplicarFiltros();
        }
    });
</script>

{% endblock %}